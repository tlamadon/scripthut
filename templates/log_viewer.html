<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptHut - {{ title }}</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='25' cy='2' r='1.8' fill='%23ccc' opacity='.5'/%3E%3Ccircle cx='23' cy='5' r='2.2' fill='%23bbb' opacity='.45'/%3E%3Ccircle cx='25.5' cy='8' r='1.8' fill='%23aaa' opacity='.4'/%3E%3Crect x='22' y='7' width='2.5' height='8' fill='%23696969'/%3E%3Cpolygon points='16,3 0,22 32,22' fill='%23B8860B'/%3E%3Cline x1='16' y1='3' x2='3' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='9' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='16' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='23' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='29' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Crect x='6' y='22' width='20' height='8' fill='%23D2B48C'/%3E%3Crect x='12' y='24' width='6' height='6' rx='3' ry='2' fill='%235C3317'/%3E%3Crect x='20' y='25' width='3' height='3' fill='%2387CEEB' stroke='%235C3317' stroke-width='.5'/%3E%3C/svg%3E">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-4">
        <header class="mb-4">
            {% include "nav.html" %}
        </header>

        <div class="flex gap-4" style="height: calc(100vh - 100px);">
            <!-- Left sidebar: task list -->
            {% if queue_items is defined and queue_items %}
            <div class="w-64 flex-shrink-0 bg-white rounded-lg shadow-md flex flex-col overflow-hidden">
                <div class="px-3 py-2 bg-gray-50 border-b">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Tasks</h3>
                </div>
                <div class="overflow-y-auto flex-1">
                    {% for item in queue_items %}
                    {% set is_current = item.task.id == task_id %}
                    {% if content_type == 'script' %}
                        {% set task_url = '/queues/' ~ queue_id ~ '/tasks/' ~ item.task.id ~ '/script' %}
                    {% elif content_type == 'json' %}
                        {% set task_url = '/queues/' ~ queue_id ~ '/tasks/' ~ item.task.id ~ '/json' %}
                    {% elif content_type == 'log' and log_type is defined %}
                        {% set task_url = '/queues/' ~ queue_id ~ '/tasks/' ~ item.task.id ~ '/logs/' ~ log_type %}
                        {% if tail is defined and tail %}
                            {% set task_url = task_url ~ '?tail=' ~ tail %}
                        {% endif %}
                    {% else %}
                        {% set task_url = '/queues/' ~ queue_id ~ '/tasks/' ~ item.task.id ~ '/logs/output' %}
                    {% endif %}
                    <a href="{{ task_url }}"
                       class="flex items-center gap-2 px-3 py-2 text-sm border-b border-gray-100 hover:bg-gray-50 transition-colors
                              {% if is_current %}bg-blue-50 border-l-2 border-l-blue-500{% endif %}"
                       title="{{ item.task.name }} ({{ item.status.value }})">
                        <!-- Status dot -->
                        <span class="w-2 h-2 rounded-full flex-shrink-0
                            {% if item.status.value == 'running' %}bg-green-500 animate-pulse
                            {% elif item.status.value == 'pending' %}bg-gray-400
                            {% elif item.status.value == 'submitted' %}bg-yellow-500
                            {% elif item.status.value == 'completed' %}bg-blue-500
                            {% elif item.status.value == 'failed' %}bg-red-500
                            {% elif item.status.value == 'dep_failed' %}bg-orange-500
                            {% endif %}"></span>
                        <!-- Task name -->
                        <span class="truncate {% if is_current %}font-semibold text-gray-900{% else %}text-gray-700{% endif %}">
                            {{ item.task.name }}
                        </span>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Main content area -->
            <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
                <!-- Tabs bar -->
                <div class="bg-white rounded-t-lg shadow-md border-b flex items-center justify-between px-2">
                    <div class="flex">
                        {% if content_type == 'log' and log_type is defined %}
                            {% set output_url = '/queues/' ~ queue_id ~ '/tasks/' ~ task_id ~ '/logs/output' %}
                            {% set error_url = '/queues/' ~ queue_id ~ '/tasks/' ~ task_id ~ '/logs/error' %}
                            {% set script_url = '/queues/' ~ queue_id ~ '/tasks/' ~ task_id ~ '/script' %}
                            {% set json_url = '/queues/' ~ queue_id ~ '/tasks/' ~ task_id ~ '/json' %}
                            {% if tail is defined and tail %}
                                {% set output_url = output_url ~ '?tail=' ~ tail %}
                                {% set error_url = error_url ~ '?tail=' ~ tail %}
                            {% endif %}
                        {% else %}
                            {% set output_url = '/queues/' ~ queue_id ~ '/tasks/' ~ task_id ~ '/logs/output' %}
                            {% set error_url = '/queues/' ~ queue_id ~ '/tasks/' ~ task_id ~ '/logs/error' %}
                            {% set script_url = '/queues/' ~ queue_id ~ '/tasks/' ~ task_id ~ '/script' %}
                            {% set json_url = '/queues/' ~ queue_id ~ '/tasks/' ~ task_id ~ '/json' %}
                        {% endif %}

                        <a href="{{ output_url }}"
                           class="px-4 py-2.5 text-sm font-medium border-b-2 transition-colors
                                  {% if content_type == 'log' and log_type == 'output' %}
                                  border-blue-500 text-blue-600
                                  {% else %}
                                  border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300
                                  {% endif %}">
                            Output
                        </a>
                        <a href="{{ error_url }}"
                           class="px-4 py-2.5 text-sm font-medium border-b-2 transition-colors
                                  {% if content_type == 'log' and log_type == 'error' %}
                                  border-blue-500 text-blue-600
                                  {% else %}
                                  border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300
                                  {% endif %}">
                            Error
                        </a>
                        <a href="{{ script_url }}"
                           class="px-4 py-2.5 text-sm font-medium border-b-2 transition-colors
                                  {% if content_type == 'script' %}
                                  border-blue-500 text-blue-600
                                  {% else %}
                                  border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300
                                  {% endif %}">
                            Script
                        </a>
                        <a href="{{ json_url }}"
                           class="px-4 py-2.5 text-sm font-medium border-b-2 transition-colors
                                  {% if content_type == 'json' %}
                                  border-blue-500 text-blue-600
                                  {% else %}
                                  border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300
                                  {% endif %}">
                            JSON
                        </a>
                    </div>

                    <!-- Right side controls -->
                    <div class="flex items-center gap-2">
                        {% if content_type == 'log' %}
                        <div class="flex items-center gap-1.5">
                            <label class="text-xs text-gray-500">Tail:</label>
                            <select
                                id="tail-select"
                                class="text-xs border rounded px-1.5 py-1"
                                onchange="updateTail(this.value)"
                            >
                                <option value="" {% if not tail %}selected{% endif %}>All</option>
                                <option value="50" {% if tail == 50 %}selected{% endif %}>50</option>
                                <option value="100" {% if tail == 100 %}selected{% endif %}>100</option>
                                <option value="500" {% if tail == 500 %}selected{% endif %}>500</option>
                            </select>
                        </div>
                        {% endif %}
                        <button
                            onclick="window.location.reload()"
                            class="px-2.5 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs"
                        >
                            Refresh
                        </button>
                        <button
                            onclick="copyToClipboard()"
                            class="px-2.5 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs text-gray-700"
                        >
                            Copy
                        </button>
                    </div>
                </div>

                <!-- Task title and path -->
                <div class="bg-white px-4 py-2 border-b shadow-md">
                    <h2 class="text-sm font-semibold text-gray-800">{{ task_name }}</h2>
                    {% if log_path %}
                    <p class="text-xs text-gray-400 font-mono truncate">{{ log_path }}</p>
                    {% endif %}
                </div>

                {% if error %}
                <div class="bg-red-100 border border-red-300 text-red-700 px-4 py-3 text-sm">
                    {{ error }}
                </div>
                {% endif %}

                <!-- Content display -->
                {% if content is not none %}
                <div class="flex-1 overflow-hidden bg-white rounded-b-lg shadow-md">
                    <pre id="content" class="h-full p-4 overflow-auto text-sm font-mono bg-gray-900 text-gray-100">{{ content }}</pre>
                </div>
                {% else %}
                <div class="flex-1 bg-white rounded-b-lg shadow-md flex items-center justify-center">
                    <p class="text-gray-500">No content available.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        function copyToClipboard() {
            const content = document.getElementById('content');
            if (!content) return;
            navigator.clipboard.writeText(content.textContent).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = originalText; }, 1500);
            });
        }

        function updateTail(value) {
            const url = new URL(window.location.href);
            if (value) {
                url.searchParams.set('tail', value);
            } else {
                url.searchParams.delete('tail');
            }
            window.location.href = url.toString();
        }
    </script>
</body>
</html>
