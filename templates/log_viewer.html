<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptHut - {{ title }}</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='25' cy='2' r='1.8' fill='%23ccc' opacity='.5'/%3E%3Ccircle cx='23' cy='5' r='2.2' fill='%23bbb' opacity='.45'/%3E%3Ccircle cx='25.5' cy='8' r='1.8' fill='%23aaa' opacity='.4'/%3E%3Crect x='22' y='7' width='2.5' height='8' fill='%23696969'/%3E%3Cpolygon points='16,3 0,22 32,22' fill='%23B8860B'/%3E%3Cline x1='16' y1='3' x2='3' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='9' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='16' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='23' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='29' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Crect x='6' y='22' width='20' height='8' fill='%23D2B48C'/%3E%3Crect x='12' y='24' width='6' height='6' rx='3' ry='2' fill='%235C3317'/%3E%3Crect x='20' y='25' width='3' height='3' fill='%2387CEEB' stroke='%235C3317' stroke-width='.5'/%3E%3C/svg%3E">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">{{ title }}</h1>
                    {% if log_path %}
                    <p class="text-sm text-gray-500 font-mono">{{ log_path }}</p>
                    {% endif %}
                </div>
                <div class="flex items-center gap-3">
                    {% if content_type == 'log' %}
                    <!-- Refresh and tail controls -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600">Tail:</label>
                        <select
                            id="tail-select"
                            class="text-sm border rounded px-2 py-1"
                            onchange="updateTail(this.value)"
                        >
                            <option value="" {% if not tail %}selected{% endif %}>All</option>
                            <option value="50" {% if tail == 50 %}selected{% endif %}>50 lines</option>
                            <option value="100" {% if tail == 100 %}selected{% endif %}>100 lines</option>
                            <option value="500" {% if tail == 500 %}selected{% endif %}>500 lines</option>
                        </select>
                    </div>
                    <button
                        onclick="window.location.reload()"
                        class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
                    >
                        Refresh
                    </button>
                    {% endif %}
                    <a href="/queues/{{ queue_id }}" class="text-blue-600 hover:text-blue-800">
                        &larr; Back to Queue
                    </a>
                </div>
            </div>
        </header>

        {% if error %}
        <div class="bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded mb-6">
            {{ error }}
        </div>
        {% endif %}

        {% if content is not none %}
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <!-- Content toolbar -->
            <div class="px-4 py-2 bg-gray-50 border-b flex items-center justify-between">
                <span class="text-sm text-gray-600">
                    {% if content_type == 'script' %}
                    sbatch script
                    {% elif content_type == 'log' %}
                    {% if log_type == 'output' %}stdout{% else %}stderr{% endif %}
                    {% endif %}
                </span>
                <button
                    onclick="copyToClipboard()"
                    class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-gray-700"
                >
                    Copy
                </button>
            </div>

            <!-- Content display -->
            <pre id="content" class="p-4 overflow-x-auto text-sm font-mono bg-gray-900 text-gray-100 max-h-[70vh] overflow-y-auto">{{ content }}</pre>
        </div>

        {% if content_type == 'log' %}
        <!-- Log navigation -->
        <div class="mt-4 flex items-center gap-4">
            <span class="text-sm text-gray-600">View:</span>
            <a
                href="/queues/{{ queue_id }}/tasks/{{ task_id }}/logs/output{% if tail %}?tail={{ tail }}{% endif %}"
                class="text-sm {% if log_type == 'output' %}font-semibold text-blue-700{% else %}text-blue-600 hover:text-blue-800{% endif %}"
            >
                Output (stdout)
            </a>
            <a
                href="/queues/{{ queue_id }}/tasks/{{ task_id }}/logs/error{% if tail %}?tail={{ tail }}{% endif %}"
                class="text-sm {% if log_type == 'error' %}font-semibold text-blue-700{% else %}text-blue-600 hover:text-blue-800{% endif %}"
            >
                Error (stderr)
            </a>
            <span class="text-gray-300">|</span>
            <a
                href="/queues/{{ queue_id }}/tasks/{{ task_id }}/script"
                class="text-sm text-blue-600 hover:text-blue-800"
            >
                View Script
            </a>
        </div>
        {% else %}
        <!-- Script navigation -->
        <div class="mt-4 flex items-center gap-4">
            <span class="text-sm text-gray-600">View:</span>
            <a
                href="/queues/{{ queue_id }}/tasks/{{ task_id }}/logs/output"
                class="text-sm text-blue-600 hover:text-blue-800"
            >
                Output Log
            </a>
            <a
                href="/queues/{{ queue_id }}/tasks/{{ task_id }}/logs/error"
                class="text-sm text-blue-600 hover:text-blue-800"
            >
                Error Log
            </a>
        </div>
        {% endif %}
        {% else %}
        <div class="bg-white rounded-lg shadow-md p-8 text-center">
            <p class="text-gray-500">No content available.</p>
        </div>
        {% endif %}
    </div>

    <script>
        function copyToClipboard() {
            const content = document.getElementById('content').textContent;
            navigator.clipboard.writeText(content).then(() => {
                // Brief visual feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = originalText; }, 1500);
            });
        }

        function updateTail(value) {
            const url = new URL(window.location.href);
            if (value) {
                url.searchParams.set('tail', value);
            } else {
                url.searchParams.delete('tail');
            }
            window.location.href = url.toString();
        }
    </script>
</body>
</html>
