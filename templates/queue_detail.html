<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptHut - Queue {{ queue.id if queue else 'Not Found' }}</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='25' cy='2' r='1.8' fill='%23ccc' opacity='.5'/%3E%3Ccircle cx='23' cy='5' r='2.2' fill='%23bbb' opacity='.45'/%3E%3Ccircle cx='25.5' cy='8' r='1.8' fill='%23aaa' opacity='.4'/%3E%3Crect x='22' y='7' width='2.5' height='8' fill='%23696969'/%3E%3Cpolygon points='16,3 0,22 32,22' fill='%23B8860B'/%3E%3Cline x1='16' y1='3' x2='3' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='9' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='16' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='23' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='29' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Crect x='6' y='22' width='20' height='8' fill='%23D2B48C'/%3E%3Crect x='12' y='24' width='6' height='6' rx='3' ry='2' fill='%235C3317'/%3E%3Crect x='20' y='25' width='3' height='3' fill='%2387CEEB' stroke='%235C3317' stroke-width='.5'/%3E%3C/svg%3E">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <div class="flex items-center justify-between">
                {% include "nav.html" %}
            </div>
        </header>
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800">
                Queue {% if queue %}{{ queue.id }}{% else %}Not Found{% endif %}
            </h2>
            {% if queue %}
            <p class="text-gray-600 text-sm">{{ queue.source_name }} on {{ queue.cluster_name }}</p>
            {% endif %}
        </div>

        {% if error %}
        <div class="bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded mb-6">
            {{ error }}
        </div>
        {% endif %}

        {% if queue %}
        <!-- Queue Info -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6"
             id="queue-info"
             hx-get="/queues/{{ queue.id }}/info"
             hx-trigger="every 5s"
             hx-swap="innerHTML">
            {% include "queue_info.html" %}
        </div>

        <!-- Queue Items -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden"
             id="queue-items"
             hx-get="/queues/{{ queue.id }}/items"
             hx-trigger="every 5s"
             hx-swap="innerHTML">
            {% include "queue_items.html" %}
        </div>
        {% endif %}
    </div>

    {% if queue %}
    <style id="folded-groups-style"></style>
    <script>
    (function() {
        var STORAGE_KEY = 'scripthut-folded-groups-{{ queue.id }}';

        function getFolded() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
            catch(e) { return {}; }
        }

        function setFolded(folded) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(folded));
        }

        function getGroupSummary(group) {
            var rows = document.querySelectorAll('tr.task-row[data-group="' + group + '"]:not([data-error-row])');
            var total = rows.length, completed = 0, running = 0, failed = 0;
            rows.forEach(function(r) {
                var s = r.getAttribute('data-status');
                if (s === 'completed') completed++;
                else if (s === 'running' || s === 'submitted') running++;
                else if (s === 'failed' || s === 'dep_failed') failed++;
            });
            var parts = [completed + '/' + total];
            if (running) parts.push(running + ' running');
            if (failed) parts.push(failed + ' failed');
            return parts.join(', ');
        }

        function syncUI() {
            var folded = getFolded();

            // Update the persistent style tag for hiding rows
            var rules = [];
            for (var group in folded) {
                if (folded[group]) {
                    rules.push('tr.task-row[data-group="' + group + '"] { display: none; }');
                }
            }
            document.getElementById('folded-groups-style').textContent = rules.join('\n');

            // Update chevrons and summaries
            document.querySelectorAll('tr.group-header').forEach(function(header) {
                var group = header.getAttribute('data-group');
                var chevron = header.querySelector('.group-chevron');
                var summary = header.querySelector('.group-summary');
                var collapsed = !!folded[group];

                summary.textContent = getGroupSummary(group);
                chevron.style.transform = collapsed ? 'rotate(0deg)' : 'rotate(90deg)';
            });
        }

        window.toggleGroup = function(group) {
            var folded = getFolded();
            folded[group] = !folded[group];
            setFolded(folded);
            syncUI();
        };

        // Apply on initial load
        syncUI();

        // Re-apply after every htmx swap of the queue-items div
        document.getElementById('queue-items').addEventListener('htmx:afterSwap', syncUI);
    })();
    </script>
    {% endif %}
</body>
</html>
