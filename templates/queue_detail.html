<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptHut - Queue {{ queue.id if queue else 'Not Found' }}</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='25' cy='2' r='1.8' fill='%23ccc' opacity='.5'/%3E%3Ccircle cx='23' cy='5' r='2.2' fill='%23bbb' opacity='.45'/%3E%3Ccircle cx='25.5' cy='8' r='1.8' fill='%23aaa' opacity='.4'/%3E%3Crect x='22' y='7' width='2.5' height='8' fill='%23696969'/%3E%3Cpolygon points='16,3 0,22 32,22' fill='%23B8860B'/%3E%3Cline x1='16' y1='3' x2='3' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='9' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='16' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='23' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Cline x1='16' y1='3' x2='29' y2='22' stroke='%23A07000' stroke-width='.7'/%3E%3Crect x='6' y='22' width='20' height='8' fill='%23D2B48C'/%3E%3Crect x='12' y='24' width='6' height='6' rx='3' ry='2' fill='%235C3317'/%3E%3Crect x='20' y='25' width='3' height='3' fill='%2387CEEB' stroke='%235C3317' stroke-width='.5'/%3E%3C/svg%3E">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <div class="flex items-center justify-between">
                {% include "nav.html" %}
            </div>
        </header>
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800">
                Queue {% if queue %}{{ queue.id }}{% else %}Not Found{% endif %}
            </h2>
            {% if queue %}
            <p class="text-gray-600 text-sm">{{ queue.source_name }} on {{ queue.cluster_name }}</p>
            {% endif %}
        </div>

        {% if error %}
        <div class="bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded mb-6">
            {{ error }}
        </div>
        {% endif %}

        {% if queue %}
        <!-- SSE-connected queue updates -->
        <div hx-ext="sse" sse-connect="/queues/{{ queue.id }}/events">
            <!-- Queue Info -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6" id="queue-info" sse-swap="info-update"
                hx-swap="innerHTML">
                {% include "queue_info.html" %}
            </div>

            <!-- View Tabs -->
            <div class="flex gap-1 mb-4 text-sm font-medium">
                <button id="tab-table" onclick="switchTab('table')"
                    class="px-3 py-1.5 rounded-md transition-colors bg-blue-100 text-blue-700">
                    Table
                </button>
                <button id="tab-gantt" onclick="switchTab('gantt')"
                    class="px-3 py-1.5 rounded-md transition-colors text-gray-600 hover:bg-gray-100 hover:text-gray-800">
                    Gantt
                </button>
                <button id="tab-details" onclick="switchTab('details')"
                    class="px-3 py-1.5 rounded-md transition-colors text-gray-600 hover:bg-gray-100 hover:text-gray-800">
                    Details
                </button>
            </div>

            <!-- Queue Items (Table view) -->
            <div id="view-table" class="bg-white rounded-lg shadow-md overflow-hidden">
                <div id="queue-items" sse-swap="items-update" hx-swap="innerHTML">
                    {% include "queue_items.html" %}
                </div>
            </div>

            <!-- Queue Gantt (Gantt view) -->
            <div id="view-gantt" class="bg-white rounded-lg shadow-md overflow-hidden" style="display: none;">
                <div id="queue-gantt" sse-swap="gantt-update" hx-swap="innerHTML">
                    {% include "queue_gantt.html" %}
                </div>
            </div>

            <!-- Task Details view -->
            <div id="view-details" class="flex gap-4" style="display: none; height: 70vh;">
                <!-- Left sidebar: task list -->
                <div class="w-64 flex-shrink-0 bg-white rounded-lg shadow-md flex flex-col overflow-hidden">
                    <div class="px-3 py-2 bg-gray-50 border-b">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Tasks</h3>
                    </div>
                    <div class="overflow-y-auto flex-1" id="detail-sidebar">
                        {% for item in queue.items %}
                        <a href="#" onclick="showTaskDetail('{{ item.task.id }}'); return false;"
                           id="detail-sidebar-{{ item.task.id }}"
                           class="flex items-center gap-2 px-3 py-2 text-sm border-b border-gray-100 hover:bg-gray-50 transition-colors"
                           title="{{ item.task.name }} ({{ item.status.value }})">
                            <span class="w-2 h-2 rounded-full flex-shrink-0
                                {% if item.status.value == 'running' %}bg-green-500 animate-pulse
                                {% elif item.status.value == 'pending' %}bg-gray-400
                                {% elif item.status.value == 'submitted' %}bg-yellow-500
                                {% elif item.status.value == 'completed' %}bg-blue-500
                                {% elif item.status.value == 'failed' %}bg-red-500
                                {% elif item.status.value == 'dep_failed' %}bg-orange-500
                                {% endif %}"></span>
                            <span class="truncate text-gray-700">{{ item.task.name }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Main content area -->
                <div class="flex-1 flex flex-col min-w-0 overflow-hidden bg-white rounded-lg shadow-md">
                    <!-- Sub-tabs bar -->
                    <div class="border-b flex items-center justify-between px-2">
                        <div class="flex">
                            <button onclick="loadDetailContent('output')" id="dtab-output"
                                class="px-4 py-2.5 text-sm font-medium border-b-2 border-blue-500 text-blue-600">
                                Output
                            </button>
                            <button onclick="loadDetailContent('error')" id="dtab-error"
                                class="px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Error
                            </button>
                            <button onclick="loadDetailContent('script')" id="dtab-script"
                                class="px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Script
                            </button>
                            <button onclick="loadDetailContent('json')" id="dtab-json"
                                class="px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                JSON
                            </button>
                        </div>
                        <div class="flex items-center gap-2">
                            <div id="detail-tail-controls" class="flex items-center gap-1.5">
                                <label class="text-xs text-gray-500">Tail:</label>
                                <select id="detail-tail-select" class="text-xs border rounded px-1.5 py-1" onchange="refreshDetail()">
                                    <option value="">All</option>
                                    <option value="50">50</option>
                                    <option value="100" selected>100</option>
                                    <option value="500">500</option>
                                </select>
                            </div>
                            <button onclick="refreshDetail()"
                                class="px-2.5 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs">
                                Refresh
                            </button>
                            <button onclick="copyDetailContent()"
                                class="px-2.5 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs text-gray-700">
                                Copy
                            </button>
                        </div>
                    </div>

                    <!-- Task title and path -->
                    <div class="px-4 py-2 border-b" id="detail-header">
                        <p class="text-sm text-gray-500">Select a task to view details</p>
                    </div>

                    <!-- Error area -->
                    <div id="detail-error" class="bg-red-100 border border-red-300 text-red-700 px-4 py-3 text-sm" style="display:none;"></div>

                    <!-- Content display -->
                    <div class="flex-1 overflow-hidden">
                        <pre id="detail-content" class="h-full p-4 overflow-auto text-sm font-mono bg-gray-900 text-gray-100"></pre>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    {% if queue %}
    <style id="folded-groups-style"></style>
    <script>
        var _detailTaskId = null;
        var _detailType = 'output';
        var _detailQueueId = '{{ queue.id }}';

        function switchTab(tab) {
            var views = {table: 'view-table', gantt: 'view-gantt', details: 'view-details'};
            var tabs = {table: 'tab-table', gantt: 'tab-gantt', details: 'tab-details'};
            var active = 'px-3 py-1.5 rounded-md transition-colors bg-blue-100 text-blue-700';
            var inactive = 'px-3 py-1.5 rounded-md transition-colors text-gray-600 hover:bg-gray-100 hover:text-gray-800';

            for (var key in views) {
                document.getElementById(views[key]).style.display = (key === tab) ? '' : 'none';
                document.getElementById(tabs[key]).className = (key === tab) ? active : inactive;
            }

            if (tab === 'gantt') {
                setTimeout(function() {
                    if (typeof window._drawGanttDeps === 'function') window._drawGanttDeps();
                }, 20);
            }
            if (tab === 'details' && !_detailTaskId) {
                var first = document.querySelector('#detail-sidebar a');
                if (first) {
                    var id = first.id.replace('detail-sidebar-', '');
                    showTaskDetail(id);
                    return;
                }
            }
            try { localStorage.setItem('scripthut-queue-tab', tab); } catch(e) {}
        }

        function showTaskDetail(taskId, type) {
            _detailTaskId = taskId;
            _detailType = type || _detailType || 'output';
            switchTab('details');
            updateSidebarHighlight();
            fetchDetail();
        }

        function updateSidebarHighlight() {
            var sidebar = document.getElementById('detail-sidebar');
            if (!sidebar) return;
            sidebar.querySelectorAll('a').forEach(function(a) {
                var isActive = a.id === 'detail-sidebar-' + _detailTaskId;
                var nameSpan = a.querySelector('span:last-child');
                if (isActive) {
                    a.classList.add('bg-blue-50', 'border-l-2', 'border-l-blue-500');
                    if (nameSpan) { nameSpan.classList.add('font-semibold', 'text-gray-900'); nameSpan.classList.remove('text-gray-700'); }
                } else {
                    a.classList.remove('bg-blue-50', 'border-l-2', 'border-l-blue-500');
                    if (nameSpan) { nameSpan.classList.remove('font-semibold', 'text-gray-900'); nameSpan.classList.add('text-gray-700'); }
                }
            });
        }

        function loadDetailContent(type) {
            _detailType = type;
            updateDetailTabs();
            fetchDetail();
        }

        function refreshDetail() {
            fetchDetail();
        }

        function fetchDetail() {
            if (!_detailTaskId) return;
            updateDetailTabs();

            var url = '/queues/' + _detailQueueId + '/tasks/' + encodeURIComponent(_detailTaskId) + '/detail/' + _detailType;
            if (_detailType === 'output' || _detailType === 'error') {
                var tail = document.getElementById('detail-tail-select').value;
                if (tail) url += '?tail=' + tail;
            }

            document.getElementById('detail-content').textContent = 'Loading...';
            document.getElementById('detail-error').style.display = 'none';

            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.error) {
                        document.getElementById('detail-error').textContent = data.error;
                        document.getElementById('detail-error').style.display = '';
                    } else {
                        document.getElementById('detail-error').style.display = 'none';
                    }
                    document.getElementById('detail-content').textContent = data.content || 'No content available.';
                    var header = document.getElementById('detail-header');
                    var h = '<h2 class="text-sm font-semibold text-gray-800">' + escapeHtml(data.task_name) + '</h2>';
                    if (data.path) {
                        h += '<p class="text-xs text-gray-400 font-mono truncate">' + escapeHtml(data.path) + '</p>';
                    }
                    header.innerHTML = h;
                })
                .catch(function(err) {
                    document.getElementById('detail-content').textContent = 'Error loading content: ' + err;
                });
        }

        function updateDetailTabs() {
            var activeClass = 'px-4 py-2.5 text-sm font-medium border-b-2 border-blue-500 text-blue-600';
            var inactiveClass = 'px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
            ['output', 'error', 'script', 'json'].forEach(function(t) {
                document.getElementById('dtab-' + t).className = (t === _detailType) ? activeClass : inactiveClass;
            });
            document.getElementById('detail-tail-controls').style.display =
                (_detailType === 'output' || _detailType === 'error') ? '' : 'none';
        }

        function copyDetailContent() {
            var content = document.getElementById('detail-content');
            if (!content) return;
            navigator.clipboard.writeText(content.textContent).then(function() {
                var btn = event.target;
                var orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(function() { btn.textContent = orig; }, 1500);
            });
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Restore last tab preference
        (function() {
            try {
                var saved = localStorage.getItem('scripthut-queue-tab');
                if (saved === 'gantt' || saved === 'details') switchTab(saved);
            } catch(e) {}
        })();
    </script>
    <script>
        (function () {
            var STORAGE_KEY = 'scripthut-folded-groups-{{ queue.id }}';

            function getFolded() {
                try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
                catch (e) { return {}; }
            }

            function setFolded(folded) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(folded));
            }

            function getGroupSummary(group) {
                var rows = document.querySelectorAll('tr.task-row[data-group="' + group + '"]:not([data-error-row])');
                var total = rows.length, completed = 0, running = 0, failed = 0;
                rows.forEach(function (r) {
                    var s = r.getAttribute('data-status');
                    if (s === 'completed') completed++;
                    else if (s === 'running' || s === 'submitted') running++;
                    else if (s === 'failed' || s === 'dep_failed') failed++;
                });
                var parts = [completed + '/' + total];
                if (running) parts.push(running + ' running');
                if (failed) parts.push(failed + ' failed');
                return parts.join(', ');
            }

            function syncUI() {
                var folded = getFolded();

                // Update the persistent style tag for hiding rows
                var rules = [];
                for (var group in folded) {
                    if (folded[group]) {
                        rules.push('tr.task-row[data-group="' + group + '"] { display: none; }');
                    }
                }
                document.getElementById('folded-groups-style').textContent = rules.join('\n');

                // Update chevrons and summaries
                document.querySelectorAll('tr.group-header').forEach(function (header) {
                    var group = header.getAttribute('data-group');
                    var chevron = header.querySelector('.group-chevron');
                    var summary = header.querySelector('.group-summary');
                    var collapsed = !!folded[group];

                    summary.textContent = getGroupSummary(group);
                    chevron.style.transform = collapsed ? 'rotate(0deg)' : 'rotate(90deg)';
                });
            }

            window.toggleGroup = function (group) {
                var folded = getFolded();
                folded[group] = !folded[group];
                setFolded(folded);
                syncUI();
            };

            // Apply on initial load
            syncUI();

            // Re-apply after SSE swaps update the queue-items div
            document.getElementById('queue-items').addEventListener('htmx:afterSwap', syncUI);
        })();
    </script>
    {% endif %}
</body>

</html>